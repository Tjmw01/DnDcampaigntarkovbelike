<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DnD Health Tracker â€” 2 karty (MG/Gracz, online)</title>
  <style>
    :root{--bg:#1b1b1b;--panel:#2a2a2a;--muted:#bdbdbd}
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:#f0f0f0;margin:0;padding:20px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .role-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .container{max-width:1800px;margin:18px auto}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{padding:8px 14px;background:#373737;border-radius:8px;cursor:pointer}
    .tab.active{background:#4a90e2}
    .section{margin-bottom:18px;padding:18px;background:var(--panel);border-radius:12px}
    .flex{display:flex;gap:18px;flex-wrap:wrap}
    .column{flex:1;min-width:260px}
    .character-image{position:relative;max-width:600px}
    .character-image img{width:100%;border-radius:12px;display:block}
    .body-part{position:absolute;padding:6px 8px;border-radius:8px;font-size:13px;color:#111}
    /* Pozycje overlayÃ³w dopasowane do Twojej grafiki */
    #head{top:7%;left:31%}
    #torso{top:26%;left:30%}
    #left-arm{top:44%;left:4%}
    #right-arm{top:44%;left:60%}
    #left-leg{top:74%;left:10%}
    #right-leg{top:74%;left:54%}
    input[type="number"]{width:64px}
    .mg-panel{background:#232323;padding:12px;border-radius:10px}
    .small{font-size:13px;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:8px;background:#4a90e2;color:#fff;border:none;cursor:pointer}
    .btn.secondary{background:#6b6b6b}
    label.inline{display:flex;align-items:center;gap:8px}
    .hidden{display:none}
    footer{color:var(--muted);font-size:13px;margin-top:18px}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#333}
    .badge.online{background:#2e7d32}
    .badge.offline{background:#b71c1c}

    /* Statusy */
    .status-controls {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-top:8px;
    }
    .status-controls label {
      display:flex;
      flex-direction:column;
      font-size:13px;
    }
    .status-controls select,
    .status-controls input[type="text"] {
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #555;
      background:#181818;
      color:#f0f0f0;
      font-size:13px;
    }
    .status-icon {
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:18px;
      height:18px;
      border-radius:50%;
      font-size:12px;
      margin-left:4px;
      cursor:pointer;
      background:rgba(0,0,0,0.55);
      border:1px solid rgba(255,255,255,0.4);
    }
    .status-icon:hover {
      transform:scale(1.1);
    }

    /* Ekwipunek â€“ tabela */
    .inv-table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    .inv-table th,
    .inv-table td {
      border-bottom:1px solid #444;
      padding:3px 4px;
    }
    .inv-table th {
      text-align:left;
      font-weight:600;
    }
    .inv-table input[type="text"],
    .inv-table input[type="number"] {
      width:100%;
      box-sizing:border-box;
      padding:2px 4px;
      border-radius:4px;
      border:1px solid #555;
      background:#111;
      color:#f0f0f0;
      font-size:12px;
    }
    .inv-section .btn {
      margin-top:8px;
    }

    /* Karta postaci â€“ inputs */
    .sheet-section label input[type="text"],
    .sheet-section label input[type="number"] {
      padding:4px 6px;
      border-radius:6px;
      border:1px solid #555;
      background:#181818;
      color:#f0f0f0;
      font-size:13px;
      min-width:80px;
    }
    .sheet-section .sheet-ability {
      width:60px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="role-box">
        <strong>Tryb:</strong>
        <select id="roleSelect">
          <option value="unset">â€” wybierz â€”</option>
          <option value="gm">Mistrz Gry</option>
          <option value="player">Gracz</option>
        </select>
        <label class="inline small"><input type="checkbox" id="rememberRole" /> ZapamiÄ™taj wybÃ³r</label>
        <span id="connectionStatus" class="badge offline">Offline</span>
      </div>
      <div class="small">
        Kampania: <code>kampania_1</code> (zmienisz w kodzie, jeÅ›li chcesz)
        <br/>
        <button class="btn" id="openRoleSettings">Ustawienia MG</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab" data-idx="1">PostaÄ‡ 1</div>
      <div class="tab" data-idx="2">PostaÄ‡ 2</div>
    </div>

    <div id="mgPanel" class="section mg-panel hidden">
      <h3>Panel Mistrza Gry</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <label class="inline"><input type="checkbox" id="vis_name" /> PokaÅ¼ imiÄ™</label>
        <label class="inline"><input type="checkbox" id="vis_hp" /> PokaÅ¼ zdrowie</label>
        <label class="inline"><input type="checkbox" id="vis_inventory" /> PokaÅ¼ ekwipunek</label>
        <label class="inline"><input type="checkbox" id="allow_player_edit_hp" /> PozwÃ³l graczowi edytowaÄ‡ HP</label>
        <label class="inline"><input type="checkbox" id="allow_player_edit_inv" /> PozwÃ³l graczowi edytowaÄ‡ ekwipunek</label>
      </div>
      <p class="small" style="margin-top:8px;">
        Ustawienia widocznoÅ›ci i edycji sÄ… synchronizowane przez Firebase dla wszystkich graczy.
      </p>
    </div>

    <!-- Panele postaci -->
    <div id="panels">

      <!-- Panel: PostaÄ‡ 1 -->
      <div class="section panel" data-idx="1">
        <div class="flex">
          <!-- LEWA: imiÄ™ + ciaÅ‚o + statusy -->
          <div class="column">
            <h2 style="margin-top:0;">ImiÄ™ postaci</h2>
            <input type="text" class="character-name" placeholder="Wpisz imiÄ™ postaci" />

            <div class="section" style="margin-top:12px">
              <h3>Zdrowie czÄ™Å›ci ciaÅ‚a</h3>
              <div class="character-image">
                <img src="assets/images/Final_hp_photo.jpg" alt="PostaÄ‡" />

                <div class="body-part" id="head">GÅ‚owa:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="torso">Korpus:
                  <input type="number" class="hp-cur" value="20" /> /
                  <input type="number" class="hp-max" value="20" />
                </div>
                <div class="body-part" id="left-arm">L. RÄ™ka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-arm">P. RÄ™ka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="left-leg">L. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-leg">P. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
              </div>
            </div>

            <div class="section status-section" style="margin-top:12px">
              <h3>Statusy</h3>
              <div class="status-controls">
                <label>
                  CzÄ™Å›Ä‡ ciaÅ‚a
                  <select class="status-part-select">
                    <option value="head">GÅ‚owa</option>
                    <option value="torso">Korpus</option>
                    <option value="left-arm">Lewa rÄ™ka</option>
                    <option value="right-arm">Prawa rÄ™ka</option>
                    <option value="left-leg">Lewa noga</option>
                    <option value="right-leg">Prawa noga</option>
                  </select>
                </label>
                <label>
                  Status
                  <select class="status-type-select">
                    <option value="bleeding">Krwawienie</option>
                    <option value="fracture">ZÅ‚amanie</option>
                    <option value="stun">OgÅ‚uszenie</option>
                    <option value="burn">Oparzenie</option>
                    <option value="poison">Trucizna</option>
                    <option value="custom">Inny (w opisie)</option>
                  </select>
                </label>
                <label>
                  Opis
                  <input type="text" class="status-desc-input" placeholder="np. -1 HP/obr." />
                </label>
                <button type="button" class="btn secondary add-status-btn">Dodaj status</button>
              </div>
              <p class="small">Kliknij ikonÄ™ statusu, aby jÄ… usunÄ…Ä‡.</p>
            </div>
          </div>

          <!-- PRAWA: karta 5e + ekwipunek -->
          <div class="column">
            <!-- Karta postaci DnD 5e -->
            <div class="section sheet-section" style="margin-top:0">
              <h3>Karta postaci (DnD 5e)</h3>
              <div class="small">Podstawowe informacje â€“ edytowalne przez gracza.</div>

              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
                <label class="small" style="display:flex;flex-direction:column;">
                  Klasa i poziom
                  <input type="text" class="sheet-classlevel" placeholder="np. Fighter 3" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  Rasa
                  <input type="text" class="sheet-race" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  TÅ‚o
                  <input type="text" class="sheet-background" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  ImiÄ™ gracza
                  <input type="text" class="sheet-playername" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  ÅšwiatopoglÄ…d
                  <input type="text" class="sheet-alignment" placeholder="np. NG" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  DoÅ›wiadczenie
                  <input type="number" class="sheet-xp" min="0" />
                </label>
              </div>

              <div style="display:flex; flex-wrap:wrap; gap:12px; margin-top:12px;">
                <div>
                  <div class="small">Atrybuty</div>
                  <div style="display:grid; grid-template-columns:repeat(3, minmax(60px,80px)); gap:4px; margin-top:4px;">
                    <label class="small">STR <input type="number" class="sheet-ability" data-ability="str" /></label>
                    <label class="small">DEX <input type="number" class="sheet-ability" data-ability="dex" /></label>
                    <label class="small">CON <input type="number" class="sheet-ability" data-ability="con" /></label>
                    <label class="small">INT <input type="number" class="sheet-ability" data-ability="int" /></label>
                    <label class="small">WIS <input type="number" class="sheet-ability" data-ability="wis" /></label>
                    <label class="small">CHA <input type="number" class="sheet-ability" data-ability="cha" /></label>
                  </div>
                </div>

                <div>
                  <div class="small">Statystyki bojowe</div>
                  <div style="display:grid; grid-template-columns:repeat(2, minmax(80px,100px)); gap:4px; margin-top:4px;">
                    <label class="small">AC <input type="number" class="sheet-ac" /></label>
                    <label class="small">Inicjatywa <input type="number" class="sheet-init" /></label>
                    <label class="small">PrÄ™dkoÅ›Ä‡ <input type="text" class="sheet-speed" placeholder="np. 9 m" /></label>
                    <label class="small">BiegÅ‚oÅ›Ä‡ <input type="number" class="sheet-prof" /></label>
                    <label class="small">HP max <input type="number" class="sheet-hpmax" /></label>
                    <label class="small">Passive Perception <input type="number" class="sheet-passive-perc" /></label>
                  </div>
                </div>
              </div>
            </div>

            <h3>Ekwipunek</h3>
            <div class="section inv-section" style="padding:12px;">
              <div class="small" style="margin-bottom:6px;">
                Dodawaj przedmioty, zaznaczaj co jest aktualnie wyposaÅ¼one. Wszystko synchronizuje siÄ™ online.
              </div>

              <table class="inv-table">
                <thead>
                  <tr>
                    <th>Nazwa</th>
                    <th>Typ</th>
                    <th>IloÅ›Ä‡</th>
                    <th>Notatki</th>
                    <th style="text-align:center;">WyposaÅ¼one</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody class="inv-body">
                  <!-- wiersze dodaje JS -->
                </tbody>
              </table>

              <button type="button" class="btn secondary add-item-btn">Dodaj przedmiot</button>
            </div>

            <div style="margin-top:18px">
              <button class="btn" data-action="export">Eksportuj (JSON)</button>
              <button class="btn secondary" data-action="import">Importuj (wklej JSON)</button>
            </div>

            <div style="margin-top:12px" class="small">
              Stan zapisuje siÄ™ lokalnie (localStorage) i online (Firebase) dla tej postaci.
            </div>
          </div>
        </div>
      </div>

      <!-- Panel: PostaÄ‡ 2 -->
      <div class="section panel" data-idx="2">
        <div class="flex">
          <!-- LEWA: imiÄ™ + ciaÅ‚o + statusy -->
          <div class="column">
            <h2 style="margin-top:0;">ImiÄ™ postaci</h2>
            <input type="text" class="character-name" placeholder="Wpisz imiÄ™ postaci" />

            <div class="section" style="margin-top:12px">
              <h3>Zdrowie czÄ™Å›ci ciaÅ‚a</h3>
              <div class="character-image">
                <img src="assets/images/Final_hp_photo.jpg" alt="PostaÄ‡" />

                <div class="body-part" id="head">GÅ‚owa:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="torso">Korpus:
                  <input type="number" class="hp-cur" value="20" /> /
                  <input type="number" class="hp-max" value="20" />
                </div>
                <div class="body-part" id="left-arm">L. RÄ™ka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-arm">P. RÄ™ka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="left-leg">L. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-leg">P. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
              </div>
            </div>

            <div class="section status-section" style="margin-top:12px">
              <h3>Statusy</h3>
              <div class="status-controls">
                <label>
                  CzÄ™Å›Ä‡ ciaÅ‚a
                  <select class="status-part-select">
                    <option value="head">GÅ‚owa</option>
                    <option value="torso">Korpus</option>
                    <option value="left-arm">Lewa rÄ™ka</option>
                    <option value="right-arm">Prawa rÄ™ka</option>
                    <option value="left-leg">Lewa noga</option>
                    <option value="right-leg">Prawa noga</option>
                  </select>
                </label>
                <label>
                  Status
                  <select class="status-type-select">
                    <option value="bleeding">Krwawienie</option>
                    <option value="fracture">ZÅ‚amanie</option>
                    <option value="stun">OgÅ‚uszenie</option>
                    <option value="burn">Oparzenie</option>
                    <option value="poison">Trucizna</option>
                    <option value="custom">Inny (w opisie)</option>
                  </select>
                </label>
                <label>
                  Opis
                  <input type="text" class="status-desc-input" placeholder="np. -1 HP/obr." />
                </label>
                <button type="button" class="btn secondary add-status-btn">Dodaj status</button>
              </div>
              <p class="small">Kliknij ikonÄ™ statusu, aby jÄ… usunÄ…Ä‡.</p>
            </div>
          </div>

          <!-- PRAWA: karta 5e + ekwipunek -->
          <div class="column">
            <!-- Karta postaci DnD 5e -->
            <div class="section sheet-section" style="margin-top:0">
              <h3>Karta postaci (DnD 5e)</h3>
              <div class="small">Podstawowe informacje â€“ edytowalne przez gracza.</div>

              <div style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;">
                <label class="small" style="display:flex;flex-direction:column;">
                  Klasa i poziom
                  <input type="text" class="sheet-classlevel" placeholder="np. Rogue 2" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  Rasa
                  <input type="text" class="sheet-race" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  TÅ‚o
                  <input type="text" class="sheet-background" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  ImiÄ™ gracza
                  <input type="text" class="sheet-playername" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  ÅšwiatopoglÄ…d
                  <input type="text" class="sheet-alignment" placeholder="np. CN" />
                </label>
                <label class="small" style="display:flex;flex-direction:column;">
                  DoÅ›wiadczenie
                  <input type="number" class="sheet-xp" min="0" />
                </label>
              </div>

              <div style="display:flex; flex-wrap:wrap; gap:12px; margin-top:12px;">
                <div>
                  <div class="small">Atrybuty</div>
                  <div style="display:grid; grid-template-columns:repeat(3, minmax(60px,80px)); gap:4px; margin-top:4px;">
                    <label class="small">STR <input type="number" class="sheet-ability" data-ability="str" /></label>
                    <label class="small">DEX <input type="number" class="sheet-ability" data-ability="dex" /></label>
                    <label class="small">CON <input type="number" class="sheet-ability" data-ability="con" /></label>
                    <label class="small">INT <input type="number" class="sheet-ability" data-ability="int" /></label>
                    <label class="small">WIS <input type="number" class="sheet-ability" data-ability="wis" /></label>
                    <label class="small">CHA <input type="number" class="sheet-ability" data-ability="cha" /></label>
                  </div>
                </div>

                <div>
                  <div class="small">Statystyki bojowe</div>
                  <div style="display:grid; grid-template-columns:repeat(2, minmax(80px,100px)); gap:4px; margin-top:4px;">
                    <label class="small">AC <input type="number" class="sheet-ac" /></label>
                    <label class="small">Inicjatywa <input type="number" class="sheet-init" /></label>
                    <label class="small">PrÄ™dkoÅ›Ä‡ <input type="text" class="sheet-speed" placeholder="np. 9 m" /></label>
                    <label class="small">BiegÅ‚oÅ›Ä‡ <input type="number" class="sheet-prof" /></label>
                    <label class="small">HP max <input type="number" class="sheet-hpmax" /></label>
                    <label class="small">Passive Perception <input type="number" class="sheet-passive-perc" /></label>
                  </div>
                </div>
              </div>
            </div>

            <h3>Ekwipunek</h3>
            <div class="section inv-section" style="padding:12px;">
              <div class="small" style="margin-bottom:6px;">
                Dodawaj przedmioty, zaznaczaj co jest aktualnie wyposaÅ¼one. Wszystko synchronizuje siÄ™ online.
              </div>

              <table class="inv-table">
                <thead>
                  <tr>
                    <th>Nazwa</th>
                    <th>Typ</th>
                    <th>IloÅ›Ä‡</th>
                    <th>Notatki</th>
                    <th style="text-align:center;">WyposaÅ¼one</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody class="inv-body">
                  <!-- wiersze dodaje JS -->
                </tbody>
              </table>

              <button type="button" class="btn secondary add-item-btn">Dodaj przedmiot</button>
            </div>

            <div style="margin-top:18px">
              <button class="btn" data-action="export">Eksportuj (JSON)</button>
              <button class="btn secondary" data-action="import">Importuj (wklej JSON)</button>
            </div>

            <div style="margin-top:12px" class="small">
              Stan zapisuje siÄ™ lokalnie (localStorage) i online (Firebase) dla tej postaci.
            </div>
          </div>
        </div>
      </div>

    </div>

    <footer>
      Klucze lokalnego zapisu: <code>dndTrackerState_1</code>, <code>dndTrackerState_2</code>.<br/>
      Ustawienia widocznoÅ›ci: <code>games/kampania_1/visibility</code> w Firebase.<br/>
      Stan postaci: <code>games/kampania_1/characters/1</code>, <code>/2</code>.
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // TwÃ³j config
    const firebaseConfig = { 
      apiKey: "AIzaSyD9xoh-2YXVMcsNvIlrflClIjXP7xDIwPQ",
      authDomain: "dnd-realtime-31cc4.firebaseapp.com",
      projectId: "dnd-realtime-31cc4",
      storageBucket: "dnd-realtime-31cc4.firebasestorage.app",
      messagingSenderId: "611606204130",
      appId: "1:611606204130:web:1fefd2fb662ccd9f7858bb",
      databaseURL: "https://dnd-realtime-31cc4-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameId = "kampania_1"; // jeÅ›li chcesz kolejnÄ… kampaniÄ™, zmieÅ„ to np. na "kampania_2"

    // Ikony i nazwy statusÃ³w
    const STATUS_ICON = {
      bleeding: "ðŸ©¸",
      fracture: "ðŸ¦´",
      stun: "ðŸ’«",
      burn: "ðŸ”¥",
      poison: "â˜ ï¸",
      custom: "âš ï¸"
    };

    const STATUS_LABEL = {
      bleeding: "Krwawienie",
      fracture: "ZÅ‚amanie",
      stun: "OgÅ‚uszenie",
      burn: "Oparzenie",
      poison: "Trucizna",
      custom: "Status"
    };

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const roleSelect = $('#roleSelect');
    const rememberRole = $('#rememberRole');
    const mgPanel = $('#mgPanel');
    const tabs = $$('#tabs .tab');
    const panels = $$('.panel');
    const connectionStatus = $('#connectionStatus');

    let currentRole = 'unset';
    let currentPlayerIdx = localStorage.getItem('dndPlayerIndex') || '1';
    let isApplyingFromServer = false;

    function defaultVisibility(){
      return {
        showName:true,
        showHP:true,
        showInventory:true,
        allowPlayerEditHP:false,
        allowPlayerEditInv:false
      };
    }

    let visibility = defaultVisibility();

    function storageKeyFor(idx){ return 'dndTrackerState_' + idx; }

    // PoÅ‚Ä…czenie z Firebase (prosty wskaÅºnik)
    (function setupConnectionIndicator(){
      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", snap => {
        if (snap.val() === true) {
          connectionStatus.textContent = "Online";
          connectionStatus.classList.remove("offline");
          connectionStatus.classList.add("online");
        } else {
          connectionStatus.textContent = "Offline";
          connectionStatus.classList.remove("online");
          connectionStatus.classList.add("offline");
        }
      });
    })();

    function createStatusIcon(type, desc){
      const iconEl = document.createElement('span');
      iconEl.className = 'status-icon';
      iconEl.dataset.type = type || 'custom';
      iconEl.dataset.desc = desc || '';
      const iconChar = STATUS_ICON[type] || STATUS_ICON.custom;
      const label = STATUS_LABEL[type] || STATUS_LABEL.custom;
      iconEl.textContent = iconChar;
      iconEl.title = desc ? (label + ': ' + desc) : label;

      // klikniÄ™cie usuwa status
      iconEl.addEventListener('click', () => {
        const panel = iconEl.closest('.panel');
        const idx = panel.dataset.idx;
        iconEl.remove();
        saveStateWithRole(idx); // zapis + sync
      });

      return iconEl;
    }

    function createInventoryRow(item) {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><input type="text" class="inv-name" value="${item.name || ''}" /></td>
        <td><input type="text" class="inv-type" value="${item.type || ''}" /></td>
        <td><input type="number" class="inv-qty" min="0" value="${item.qty != null ? item.qty : 1}" /></td>
        <td><input type="text" class="inv-notes" value="${item.notes || ''}" /></td>
        <td style="text-align:center;">
          <input type="checkbox" class="inv-equipped" ${item.equipped ? 'checked' : ''} />
        </td>
        <td style="text-align:center;">
          <button type="button" class="btn secondary inv-del-btn" style="padding:2px 6px; font-size:11px;">X</button>
        </td>
      `;
      return tr;
    }

    // --- Zbieranie i aplikowanie stanu postaci ---

    function collectStateFromPanel(panel){
      const state = { name: '', parts:{}, inventory:[], statuses:{}, sheet:{} };
      const nameEl = panel.querySelector('.character-name');
      state.name = nameEl ? nameEl.value : '';

      // HP + statusy
      ['head','torso','left-arm','right-arm','left-leg','right-leg'].forEach(id=>{
        const el = panel.querySelector('.body-part#'+id);
        if(!el) return;
        const cur = el.querySelector('.hp-cur').value;
        const max = el.querySelector('.hp-max').value;
        state.parts[id] = [cur,max];

        // statusy dla tej czÄ™Å›ci
        state.statuses[id] = [];
        el.querySelectorAll('.status-icon').forEach(icon=>{
          state.statuses[id].push({
            type: icon.dataset.type || 'custom',
            desc: icon.dataset.desc || ''
          });
        });
      });

      // Ekwipunek â€“ tabela
      state.inventory = [];
      const tbody = panel.querySelector('.inv-body');
      if (tbody) {
        tbody.querySelectorAll('tr').forEach(tr => {
          state.inventory.push({
            name:  tr.querySelector('.inv-name')?.value || '',
            type:  tr.querySelector('.inv-type')?.value || '',
            qty:   parseInt(tr.querySelector('.inv-qty')?.value || '0') || 0,
            notes: tr.querySelector('.inv-notes')?.value || '',
            equipped: tr.querySelector('.inv-equipped')?.checked || false
          });
        });
      }

      // Karta postaci (sheet)
      state.sheet = {
        classLevel: panel.querySelector('.sheet-classlevel')?.value || '',
        race:       panel.querySelector('.sheet-race')?.value || '',
        background: panel.querySelector('.sheet-background')?.value || '',
        playerName: panel.querySelector('.sheet-playername')?.value || '',
        alignment:  panel.querySelector('.sheet-alignment')?.value || '',
        xp:         parseInt(panel.querySelector('.sheet-xp')?.value || '0') || 0,
        abilities: {},
        ac:         parseInt(panel.querySelector('.sheet-ac')?.value || '0') || 0,
        init:       parseInt(panel.querySelector('.sheet-init')?.value || '0') || 0,
        speed:      panel.querySelector('.sheet-speed')?.value || '',
        profBonus:  parseInt(panel.querySelector('.sheet-prof')?.value || '0') || 0,
        hpMax:      parseInt(panel.querySelector('.sheet-hpmax')?.value || '0') || 0,
        passivePerc:parseInt(panel.querySelector('.sheet-passive-perc')?.value || '0') || 0
      };

      panel.querySelectorAll('.sheet-ability').forEach(inp => {
        const key = inp.dataset.ability;
        if (!key) return;
        state.sheet.abilities[key] = parseInt(inp.value || '0') || 0;
      });

      return state;
    }

    function applyStateToPanel(panel, state){
      if(!state) return;
      const nameEl = panel.querySelector('.character-name');
      if (nameEl) nameEl.value = state.name || '';

      // HP
      Object.entries(state.parts || {}).forEach(([id,vals])=>{
        const el = panel.querySelector('.body-part#'+id);
        if(!el) return;
        const curEl = el.querySelector('.hp-cur');
        const maxEl = el.querySelector('.hp-max');
        if (curEl) curEl.value = vals[0];
        if (maxEl) maxEl.value = vals[1];
      });

      // Ekwipunek â€“ odtwarzanie tabeli
      const tbody = panel.querySelector('.inv-body');
      if (tbody) {
        tbody.innerHTML = '';
        (state.inventory || []).forEach(item => {
          const row = createInventoryRow(item);
          tbody.appendChild(row);
        });
      }

      // Statusy â€“ najpierw czyÅ›cimy stare ikonki
      ['head','torso','left-arm','right-arm','left-leg','right-leg'].forEach(id=>{
        const el = panel.querySelector('.body-part#'+id);
        if(!el) return;
        el.querySelectorAll('.status-icon').forEach(icon=> icon.remove());

        if (!state.statuses || !state.statuses[id]) return;
        state.statuses[id].forEach(st => {
          const iconEl = createStatusIcon(st.type, st.desc);
          el.appendChild(iconEl);
        });
      });

      // Karta postaci (sheet)
      if (state.sheet) {
        const sh = state.sheet;
        panel.querySelector('.sheet-classlevel')  && (panel.querySelector('.sheet-classlevel').value  = sh.classLevel || '');
        panel.querySelector('.sheet-race')        && (panel.querySelector('.sheet-race').value        = sh.race || '');
        panel.querySelector('.sheet-background')  && (panel.querySelector('.sheet-background').value  = sh.background || '');
        panel.querySelector('.sheet-playername')  && (panel.querySelector('.sheet-playername').value  = sh.playerName || '');
        panel.querySelector('.sheet-alignment')   && (panel.querySelector('.sheet-alignment').value   = sh.alignment || '');
        panel.querySelector('.sheet-xp')          && (panel.querySelector('.sheet-xp').value          = sh.xp ?? 0);
        panel.querySelector('.sheet-ac')          && (panel.querySelector('.sheet-ac').value          = sh.ac ?? 0);
        panel.querySelector('.sheet-init')        && (panel.querySelector('.sheet-init').value        = sh.init ?? 0);
        panel.querySelector('.sheet-speed')       && (panel.querySelector('.sheet-speed').value       = sh.speed || '');
        panel.querySelector('.sheet-prof')        && (panel.querySelector('.sheet-prof').value        = sh.profBonus ?? 0);
        panel.querySelector('.sheet-hpmax')       && (panel.querySelector('.sheet-hpmax').value       = sh.hpMax ?? 0);
        panel.querySelector('.sheet-passive-perc')&& (panel.querySelector('.sheet-passive-perc').value= sh.passivePerc ?? 0);

        if (sh.abilities) {
          panel.querySelectorAll('.sheet-ability').forEach(inp => {
            const key = inp.dataset.ability;
            if (!key) return;
            inp.value = sh.abilities[key] ?? 0;
          });
        }
      }
    }

    function saveStateFor(idx, options){
      options = options || {};
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      if(!panel) return;
      const state = collectStateFromPanel(panel);
      // lokalny backup
      localStorage.setItem(storageKeyFor(idx), JSON.stringify(state));
      // wysyÅ‚ka do Firebase (jeÅ›li ustawiono push)
      if (options.push) {
        db.ref('games/'+gameId+'/characters/'+idx).set(state);
      }
    }

    function saveStateWithRole(idx){
      if(currentRole === 'gm'){
        saveStateFor(idx, {push:true});
      } else if(currentRole === 'player'){
        // gracz pcha tylko to, na co pozwoli MG (HP/ekwipunek/sheet)
        saveStateFor(idx, {push:true});
      } else {
        saveStateFor(idx, {push:false});
      }
    }

    function loadStateFromLocal(idx){
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      const str = localStorage.getItem(storageKeyFor(idx));
      if(!panel || !str) return;
      try {
        const state = JSON.parse(str);
        applyStateToPanel(panel, state);
        updateColorsFor(panel);
      } catch (e) {
        console.warn('BÅ‚Ä…d loadStateFromLocal', e);
      }
    }

    // --- Kolory HP ---

    function updateColorsFor(panel){
      panel.querySelectorAll('.body-part').forEach(part=>{
        const cur = parseInt(part.querySelector('.hp-cur').value) || 0;
        const max = parseInt(part.querySelector('.hp-max').value) || 1;
        const ratio = cur / max;
        let color = '#4caf50';
        if(ratio < 0.75) color = '#ffb74d';
        if(ratio < 0.25) color = '#f44336';
        if(ratio < 0) color = '#f000000';
        part.style.background = color;
      });
    }

    // --- Firebase: subskrypcje ---

    function subscribeToCharacter(idx){
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      if(!panel) return;
      db.ref('games/'+gameId+'/characters/'+idx).on('value', snap => {
        const state = snap.val();
        if(!state) return;
        isApplyingFromServer = true;
        applyStateToPanel(panel, state);
        updateColorsFor(panel);
        isApplyingFromServer = false;
      });
    }

    function subscribeToVisibility(){
      db.ref('games/'+gameId+'/visibility').on('value', snap => {
        const v = snap.val();
        if (v) {
          visibility = Object.assign(defaultVisibility(), v);
        } else {
          visibility = defaultVisibility();
        }
        applyVisibilityCheckboxes();
        applyVisibilityToAll();
      });
    }

    function pushVisibilityToServer(){
      db.ref('games/'+gameId+'/visibility').set(visibility);
    }

    // --- Role & UI ---

    function loadSavedRole(){
      return localStorage.getItem('dndRole') || 'unset';
    }

    function saveRole(role, remember){
      if(remember){
        localStorage.setItem('dndRole', role);
      } else {
        localStorage.removeItem('dndRole');
      }
    }

    function askWhichPlayer(){
      const choice = prompt('JesteÅ› Graczem â€” ktÃ³rÄ… postaÄ‡ wybierasz? (1 lub 2)', currentPlayerIdx);
      const idx = (choice === '2') ? '2' : '1';
      currentPlayerIdx = idx;
      localStorage.setItem('dndPlayerIndex', idx);
      activateTab(idx);
      applyRoleUI();
    }

    function applyRoleUI(){
      currentRole = roleSelect.value;

      if(currentRole === 'gm') {
        mgPanel.classList.remove('hidden');
      } else {
        mgPanel.classList.add('hidden');
      }

      if(currentRole === 'player'){
        const playerIdx = currentPlayerIdx || '1';
        activateTab(playerIdx);
        tabs.forEach(t => t.classList.toggle('hidden', t.dataset.idx !== playerIdx));
      } else {
        tabs.forEach(t => t.classList.remove('hidden'));
      }

      applyVisibilityToAll();
    }

    // --- ZakÅ‚adki ---

    function activateTab(idx){
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.idx === String(idx)));
      panels.forEach(p=> p.style.display = (p.dataset.idx === String(idx)) ? 'block' : 'none');
      // lokalny backup (na starcie) â€“ potem i tak nadpisze Firebase
      loadStateFromLocal(idx);
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        activateTab(tab.dataset.idx);
      });
    });

    // --- WidocznoÅ›Ä‡ / uprawnienia ---

    function applyVisibilityCheckboxes(){
      // tylko MG widzi checkboxy, ale logika i tak dziaÅ‚a dla wszystkich
      const visName = $('#vis_name');
      const visHp = $('#vis_hp');
      const visInv = $('#vis_inventory');
      const allowHp = $('#allow_player_edit_hp');
      const allowInv = $('#allow_player_edit_inv');
      if (!visName) return;

      visName.checked = visibility.showName;
      visHp.checked = visibility.showHP;
      visInv.checked = visibility.showInventory;
      allowHp.checked = visibility.allowPlayerEditHP;
      allowInv.checked = visibility.allowPlayerEditInv;
    }

    function applyVisibilityToPanel(panel){
      const v = visibility;

      // ImiÄ™
      const nameEl = panel.querySelector('.character-name');
      if(nameEl){
        nameEl.style.display = v.showName ? 'block' : 'none';
      }

      // Ekwipunek (caÅ‚a sekcja)
      panel.querySelectorAll('.inv-section').forEach(sec=>{
        sec.style.display = v.showInventory ? 'block' : 'none';
      });

      // HP (same cyferki, label zostaje)
      panel.querySelectorAll('.body-part').forEach(bp=>{
        bp.querySelectorAll('input').forEach(inp=>{
          inp.style.display = v.showHP ? 'inline-block' : 'none';
        });
      });

      // readonly dla gracza
      if(currentRole === 'player'){
        const playerIdx = currentPlayerIdx || '1';
        if(panel.dataset.idx !== playerIdx) return;
        panel.querySelectorAll('.hp-cur, .hp-max').forEach(i=> i.readOnly = !v.allowPlayerEditHP);

        const invInputs = panel.querySelectorAll('.inv-name, .inv-type, .inv-qty, .inv-notes, .inv-equipped');
        invInputs.forEach(i => {
          if (i.type === 'checkbox') {
            i.disabled = !v.allowPlayerEditInv;
          } else {
            i.readOnly = !v.allowPlayerEditInv;
          }
        });
      } else {
        panel.querySelectorAll('.hp-cur, .hp-max').forEach(i=> i.readOnly = false);
        const invInputs = panel.querySelectorAll('.inv-name, .inv-type, .inv-qty, .inv-notes, .inv-equipped');
        invInputs.forEach(i => {
          if (i.type === 'checkbox') {
            i.disabled = false;
          } else {
            i.readOnly = false;
          }
        });
      }
    }

    function applyVisibilityToAll(){
      panels.forEach(panel => applyVisibilityToPanel(panel));
    }

    // --- Zdarzenia globalne ---

    // input -> zapis / sync
    document.addEventListener('input', e=>{
      const panel = e.target.closest('.panel');
      if(!panel) return;
      const idx = panel.dataset.idx;

      // HP kolory
      updateColorsFor(panel);

      if(isApplyingFromServer) return; // nie echoâ€™ujemy zmian z Firebase

      const role = currentRole;
      const v = visibility;
      const isHpInput = e.target.classList.contains('hp-cur') || e.target.classList.contains('hp-max');
      const isInvField = e.target.closest('.inv-table') !== null;
      const isSheetField = e.target.classList.contains('sheet-classlevel')
                        || e.target.classList.contains('sheet-race')
                        || e.target.classList.contains('sheet-background')
                        || e.target.classList.contains('sheet-playername')
                        || e.target.classList.contains('sheet-alignment')
                        || e.target.classList.contains('sheet-xp')
                        || e.target.classList.contains('sheet-ac')
                        || e.target.classList.contains('sheet-init')
                        || e.target.classList.contains('sheet-speed')
                        || e.target.classList.contains('sheet-prof')
                        || e.target.classList.contains('sheet-hpmax')
                        || e.target.classList.contains('sheet-passive-perc')
                        || e.target.classList.contains('sheet-ability');

      let canPush = false;

      if(role === 'gm'){
        canPush = true; // MG moÅ¼e wszystko
      } else if(role === 'player'){
        if (isSheetField) canPush = true; // karta postaci edytowalna przez gracza
        if (isHpInput && v.allowPlayerEditHP) canPush = true;
        if (isInvField && v.allowPlayerEditInv) canPush = true;
      } else {
        canPush = false;
      }

      saveStateFor(idx, {push:canPush});
    });

    // Dodawanie/usuwanie przedmiotÃ³w
    document.querySelectorAll('.add-item-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const panel = btn.closest('.panel');
        const idx = panel.dataset.idx;
        const tbody = panel.querySelector('.inv-body');
        const row = createInventoryRow({ name:'', type:'', qty:1, notes:'', equipped:false });
        tbody.appendChild(row);
        saveStateWithRole(idx);
      });
    });

    document.addEventListener('click', e => {
      if (!e.target.classList.contains('inv-del-btn')) return;
      const panel = e.target.closest('.panel');
      if (!panel) return;
      const idx = panel.dataset.idx;
      e.target.closest('tr').remove();
      saveStateWithRole(idx);
    });

    // Eksport / import JSON
    document.querySelectorAll('[data-action="export"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const panel = e.target.closest('.panel');
        const idx = panel.dataset.idx;
        const str = localStorage.getItem(storageKeyFor(idx)) || '{}';
        prompt('Skopiuj JSON (export):', str);
      });
    });

    document.querySelectorAll('[data-action="import"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const panel = e.target.closest('.panel');
        const idx = panel.dataset.idx;
        const txt = prompt('Wklej JSON do importu:');
        if(!txt) return;
        try{
          const state = JSON.parse(txt);
          // lokalnie
          localStorage.setItem(storageKeyFor(idx), txt);
          // do Firebase
          db.ref('games/'+gameId+'/characters/'+idx).set(state);
          // i od razu aplikujemy
          isApplyingFromServer = true;
          applyStateToPanel(panel, state);
          updateColorsFor(panel);
          isApplyingFromServer = false;
          alert('Zaimportowano');
        }catch(err){
          alert('BÅ‚Ä…d JSON: '+err.message);
        }
      });
    });

    // Ustawienia MG -> checkboxy visibility
    ['vis_name','vis_hp','vis_inventory','allow_player_edit_hp','allow_player_edit_inv'].forEach(id=>{
      const el = $('#'+id);
      if(!el) return;
      el.addEventListener('change', ()=>{
        visibility.showName = $('#vis_name').checked;
        visibility.showHP = $('#vis_hp').checked;
        visibility.showInventory = $('#vis_inventory').checked;
        visibility.allowPlayerEditHP = $('#allow_player_edit_hp').checked;
        visibility.allowPlayerEditInv = $('#allow_player_edit_inv').checked;
        pushVisibilityToServer();
        applyVisibilityToAll();
      });
    });

    // ObsÅ‚uga dodawania statusÃ³w
    document.querySelectorAll('.add-status-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const panel = btn.closest('.panel');
        const idx = panel.dataset.idx;

        const partSelect = panel.querySelector('.status-part-select');
        const typeSelect = panel.querySelector('.status-type-select');
        const descInput = panel.querySelector('.status-desc-input');

        const partId = partSelect.value;
        const type = typeSelect.value;
        const desc = descInput.value.trim();

        const bodyPartEl = panel.querySelector('.body-part#'+partId);
        if(!bodyPartEl) return;

        const iconEl = createStatusIcon(type, desc);
        bodyPartEl.appendChild(iconEl);

        descInput.value = '';
        saveStateWithRole(idx);
      });
    });

    // Przycisk "Ustawienia MG" â€“ szybki switch do MG
    $('#openRoleSettings').addEventListener('click', ()=>{
      roleSelect.value = 'gm';
      rememberRole.checked = false;
      saveRole('gm', false);
      applyRoleUI();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Zmiana roli
    roleSelect.addEventListener('change', e=>{
      const r = e.target.value;
      if(rememberRole.checked) saveRole(r, true);
      currentRole = r;
      if(r === 'player'){
        askWhichPlayer();
      } else {
        applyRoleUI();
      }
    });

    rememberRole.addEventListener('change', ()=>{
      if(rememberRole.checked){
        saveRole(roleSelect.value, true);
      } else {
        saveRole('unset', false);
      }
    });

    // --- Init ---

    (function init(){
      // role & player index
      const savedRole = loadSavedRole();
      if(savedRole && savedRole !== 'unset'){
        roleSelect.value = savedRole;
        rememberRole.checked = true;
        currentRole = savedRole;
      }
      currentPlayerIdx = localStorage.getItem('dndPlayerIndex') || currentPlayerIdx;

      // zakÅ‚adki
      activateTab(currentPlayerIdx || '1');

      // Firebase subskrypcje
      subscribeToVisibility();
      subscribeToCharacter(1);
      subscribeToCharacter(2);

      // po ustaleniu roli
      if(currentRole === 'player'){
        askWhichPlayer();
      } else {
        applyRoleUI();
      }

      applyVisibilityToAll();
    })();

    // debug
    window._dnd = { collectStateFromPanel, applyStateToPanel, visibility };
  </script>
</body>
</html>

