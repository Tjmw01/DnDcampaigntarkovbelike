<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DnD Health Tracker — 2 karty (MG/Gracz, online)</title>
  <style>
    :root{--bg:#1b1b1b;--panel:#2a2a2a;--muted:#bdbdbd}
    body{font-family:Inter, Arial, sans-serif;background:var(--bg);color:#f0f0f0;margin:0;padding:20px}
    .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .role-box{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .container{max-width:1800px;margin:18px auto}
    .tabs{display:flex;gap:8px;margin:12px 0}
    .tab{padding:8px 14px;background:#373737;border-radius:8px;cursor:pointer}
    .tab.active{background:#4a90e2}
    .section{margin-bottom:18px;padding:18px;background:var(--panel);border-radius:12px}
    .flex{display:flex;gap:18px;flex-wrap:wrap}
    .column{flex:1;min-width:260px}
    .character-image{position:relative;max-width:600px}
    .character-image img{width:100%;border-radius:12px;display:block}
    .body-part{position:absolute;padding:6px 8px;border-radius:8px;font-size:13px;color:#111}
    /* Pozycje overlayów dopasowane do Twojej grafiki */
    #head{top:7%;left:31%}
    #torso{top:26%;left:30%}
    #left-arm{top:44%;left:4%}
    #right-arm{top:44%;left:60%}
    #left-leg{top:74%;left:10%}
    #right-leg{top:74%;left:54%}
    input[type="number"]{width:64px}
    .inventory-item{display:block;margin-bottom:8px}
    .mg-panel{background:#232323;padding:12px;border-radius:10px}
    .small{font-size:13px;color:var(--muted)}
    .btn{padding:8px 12px;border-radius:8px;background:#4a90e2;color:#fff;border:none;cursor:pointer}
    .btn.secondary{background:#6b6b6b}
    label.inline{display:flex;align-items:center;gap:8px}
    .hidden{display:none}
    footer{color:var(--muted);font-size:13px;margin-top:18px}
    .badge{padding:4px 8px;border-radius:999px;font-size:12px;background:#333}
    .badge.online{background:#2e7d32}
    .badge.offline{background:#b71c1c}
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="role-box">
        <strong>Tryb:</strong>
        <select id="roleSelect">
          <option value="unset">— wybierz —</option>
          <option value="gm">Mistrz Gry</option>
          <option value="player">Gracz</option>
        </select>
        <label class="inline small"><input type="checkbox" id="rememberRole" /> Zapamiętaj wybór</label>
        <span id="connectionStatus" class="badge offline">Offline</span>
      </div>
      <div class="small">
        Kampania: <code>kampania_1</code> (zmienisz w kodzie, jeśli chcesz)
        <br/>
        <button class="btn" id="openRoleSettings">Ustawienia MG</button>
      </div>
    </div>

    <div class="tabs" id="tabs">
      <div class="tab" data-idx="1">Postać 1</div>
      <div class="tab" data-idx="2">Postać 2</div>
    </div>

    <div id="mgPanel" class="section mg-panel hidden">
      <h3>Panel Mistrza Gry</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <label class="inline"><input type="checkbox" id="vis_name" /> Pokaż imię</label>
        <label class="inline"><input type="checkbox" id="vis_hp" /> Pokaż zdrowie</label>
        <label class="inline"><input type="checkbox" id="vis_inventory" /> Pokaż ekwipunek</label>
        <label class="inline"><input type="checkbox" id="allow_player_edit_hp" /> Pozwól graczowi edytować HP</label>
        <label class="inline"><input type="checkbox" id="allow_player_edit_inv" /> Pozwól graczowi edytować ekwipunek</label>
      </div>
      <p class="small" style="margin-top:8px;">
        Ustawienia widoczności i edycji są synchronizowane przez Firebase dla wszystkich graczy.
      </p>
    </div>

    <!-- Panele postaci -->
    <div id="panels">

      <!-- Panel: Postać 1 -->
      <div class="section panel" data-idx="1">
        <div class="flex">
          <div class="column">
            <h2>Imię postaci</h2>
            <input type="text" class="character-name" placeholder="Wpisz imię postaci" />

            <div class="section" style="margin-top:12px">
              <h3>Zdrowie części ciała</h3>
              <div class="character-image">
                <img src="assets/images/Final_hp_photo.jpg" alt="Postać" />

                <div class="body-part" id="head">Głowa:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="torso">Korpus:
                  <input type="number" class="hp-cur" value="20" /> /
                  <input type="number" class="hp-max" value="20" />
                </div>
                <div class="body-part" id="left-arm">L. Ręka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-arm">P. Ręka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="left-leg">L. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-leg">P. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
              </div>
            </div>

          </div>

          <div class="column">
            <h3>Ekwipunek</h3>
            <div>
              <label class="inventory-item">Broń: <input type="text" class="inv" placeholder="np. Miecz" /></label>
              <label class="inventory-item">Zbroja: <input type="text" class="inv" placeholder="np. Skórzana Zbroja" /></label>
              <label class="inventory-item">Przedmiot 1: <input type="text" class="inv" /></label>
              <label class="inventory-item">Przedmiot 2: <input type="text" class="inv" /></label>
            </div>

            <div style="margin-top:18px">
              <button class="btn" data-action="export">Eksportuj (JSON)</button>
              <button class="btn secondary" data-action="import">Importuj (wklej JSON)</button>
            </div>

            <div style="margin-top:12px" class="small">
              Stan zapisuje się lokalnie (localStorage) i online (Firebase) dla tej postaci.
            </div>
          </div>
        </div>
      </div>

      <!-- Panel: Postać 2 -->
      <div class="section panel" data-idx="2">
        <div class="flex">
          <div class="column">
            <h2>Imię postaci</h2>
            <input type="text" class="character-name" placeholder="Wpisz imię postaci" />

            <div class="section" style="margin-top:12px">
              <h3>Zdrowie części ciała</h3>
              <div class="character-image">
                <img src="assets/images/Final_hp_photo.jpg" alt="Postać" />

                <div class="body-part" id="head">Głowa:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="torso">Korpus:
                  <input type="number" class="hp-cur" value="20" /> /
                  <input type="number" class="hp-max" value="20" />
                </div>
                <div class="body-part" id="left-arm">L. Ręka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-arm">P. Ręka:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="left-leg">L. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
                <div class="body-part" id="right-leg">P. Noga:
                  <input type="number" class="hp-cur" value="10" /> /
                  <input type="number" class="hp-max" value="10" />
                </div>
              </div>
            </div>

          </div>

          <div class="column">
            <h3>Ekwipunek</h3>
            <div>
              <label class="inventory-item">Broń: <input type="text" class="inv" placeholder="np. Miecz" /></label>
              <label class="inventory-item">Zbroja: <input type="text" class="inv" placeholder="np. Skórzana Zbroja" /></label>
              <label class="inventory-item">Przedmiot 1: <input type="text" class="inv" /></label>
              <label class="inventory-item">Przedmiot 2: <input type="text" class="inv" /></label>
            </div>

            <div style="margin-top:18px">
              <button class="btn" data-action="export">Eksportuj (JSON)</button>
              <button class="btn secondary" data-action="import">Importuj (wklej JSON)</button>
            </div>

            <div style="margin-top:12px" class="small">
              Stan zapisuje się lokalnie (localStorage) i online (Firebase) dla tej postaci.
            </div>
          </div>
        </div>
      </div>

    </div>

    <footer>
      Klucze lokalnego zapisu: <code>dndTrackerState_1</code>, <code>dndTrackerState_2</code>.<br/>
      Ustawienia widoczności: <code>games/kampania_1/visibility</code> w Firebase.<br/>
      Stan postaci: <code>games/kampania_1/characters/1</code>, <code>/2</code>.
    </footer>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Twój config
    const firebaseConfig = { 
      apiKey: "AIzaSyD9xoh-2YXVMcsNvIlrflClIjXP7xDIwPQ",
      authDomain: "dnd-realtime-31cc4.firebaseapp.com",
      projectId: "dnd-realtime-31cc4",
      storageBucket: "dnd-realtime-31cc4.firebasestorage.app",
      messagingSenderId: "611606204130",
      appId: "1:611606204130:web:1fefd2fb662ccd9f7858bb",
      databaseURL: "https://dnd-realtime-31cc4-default-rtdb.europe-west1.firebasedatabase.app/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const gameId = "kampania_1"; // jeśli chcesz kolejną kampanię, zmień to np. na "kampania_2"

    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const roleSelect = $('#roleSelect');
    const rememberRole = $('#rememberRole');
    const mgPanel = $('#mgPanel');
    const tabs = $$('#tabs .tab');
    const panels = $$('.panel');
    const connectionStatus = $('#connectionStatus');

    let currentRole = 'unset';
    let currentPlayerIdx = localStorage.getItem('dndPlayerIndex') || '1';
    let isApplyingFromServer = false;

    function defaultVisibility(){
      return {
        showName:true,
        showHP:true,
        showInventory:true,
        allowPlayerEditHP:false,
        allowPlayerEditInv:false
      };
    }

    let visibility = defaultVisibility();

    function storageKeyFor(idx){ return 'dndTrackerState_' + idx; }

    // Połączenie z Firebase (prosty wskaźnik)
    (function setupConnectionIndicator(){
      const connectedRef = db.ref(".info/connected");
      connectedRef.on("value", snap => {
        if (snap.val() === true) {
          connectionStatus.textContent = "Online";
          connectionStatus.classList.remove("offline");
          connectionStatus.classList.add("online");
        } else {
          connectionStatus.textContent = "Offline";
          connectionStatus.classList.remove("online");
          connectionStatus.classList.add("offline");
        }
      });
    })();

    // --- Zbieranie i aplikowanie stanu postaci ---

    function collectStateFromPanel(panel){
      const state = { name: '', parts:{}, inventory:[] };
      const nameEl = panel.querySelector('.character-name');
      state.name = nameEl ? nameEl.value : '';

      ['head','torso','left-arm','right-arm','left-leg','right-leg'].forEach(id=>{
        const el = panel.querySelector('.body-part#'+id);
        if(!el) return;
        const cur = el.querySelector('.hp-cur').value;
        const max = el.querySelector('.hp-max').value;
        state.parts[id]=[cur,max];
      });

      panel.querySelectorAll('.inv').forEach(i=> state.inventory.push(i.value));
      return state;
    }

    function applyStateToPanel(panel, state){
      if(!state) return;
      const nameEl = panel.querySelector('.character-name');
      if (nameEl) nameEl.value = state.name || '';

      Object.entries(state.parts || {}).forEach(([id,vals])=>{
        const el = panel.querySelector('.body-part#'+id);
        if(!el) return;
        const curEl = el.querySelector('.hp-cur');
        const maxEl = el.querySelector('.hp-max');
        if (curEl) curEl.value = vals[0];
        if (maxEl) maxEl.value = vals[1];
      });

      panel.querySelectorAll('.inv').forEach((i,idx)=>{
        if (state.inventory && state.inventory[idx] !== undefined) {
          i.value = state.inventory[idx];
        } else {
          i.value = '';
        }
      });
    }

    function saveStateFor(idx, options){
      options = options || {};
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      if(!panel) return;
      const state = collectStateFromPanel(panel);
      // lokalny backup
      localStorage.setItem(storageKeyFor(idx), JSON.stringify(state));
      // wysyłka do Firebase (jeśli ustawiono push)
      if (options.push) {
        db.ref('games/'+gameId+'/characters/'+idx).set(state);
      }
    }

    function loadStateFromLocal(idx){
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      const str = localStorage.getItem(storageKeyFor(idx));
      if(!panel || !str) return;
      try {
        const state = JSON.parse(str);
        applyStateToPanel(panel, state);
        updateColorsFor(panel);
      } catch (e) {
        console.warn('Błąd loadStateFromLocal', e);
      }
    }

    // --- Kolory HP ---

    function updateColorsFor(panel){
      panel.querySelectorAll('.body-part').forEach(part=>{
        const cur = parseInt(part.querySelector('.hp-cur').value) || 0;
        const max = parseInt(part.querySelector('.hp-max').value) || 1;
        const ratio = cur / max;
        let color = '#4caf50';
        if(ratio < 0.75) color = '#ffb74d';
        if(ratio < 0.25) color = '#f44336';
        part.style.background = color;
      });
    }

    // --- Firebase: subskrypcje ---

    function subscribeToCharacter(idx){
      const panel = document.querySelector('.panel[data-idx="'+idx+'"]');
      if(!panel) return;
      db.ref('games/'+gameId+'/characters/'+idx).on('value', snap => {
        const state = snap.val();
        if(!state) return;
        isApplyingFromServer = true;
        applyStateToPanel(panel, state);
        updateColorsFor(panel);
        isApplyingFromServer = false;
      });
    }

    function subscribeToVisibility(){
      db.ref('games/'+gameId+'/visibility').on('value', snap => {
        const v = snap.val();
        if (v) {
          visibility = Object.assign(defaultVisibility(), v);
        } else {
          visibility = defaultVisibility();
        }
        applyVisibilityCheckboxes();
        applyVisibilityToAll();
      });
    }

    function pushVisibilityToServer(){
      db.ref('games/'+gameId+'/visibility').set(visibility);
    }

    // --- Role & UI ---

    function loadSavedRole(){
      return localStorage.getItem('dndRole') || 'unset';
    }

    function saveRole(role, remember){
      if(remember){
        localStorage.setItem('dndRole', role);
      } else {
        localStorage.removeItem('dndRole');
      }
    }

    function askWhichPlayer(){
      const choice = prompt('Jesteś Graczem — którą postać wybierasz? (1 lub 2)', currentPlayerIdx);
      const idx = (choice === '2') ? '2' : '1';
      currentPlayerIdx = idx;
      localStorage.setItem('dndPlayerIndex', idx);
      activateTab(idx);
      applyRoleUI();
    }

    function applyRoleUI(){
      currentRole = roleSelect.value;

      if(currentRole === 'gm') {
        mgPanel.classList.remove('hidden');
      } else {
        mgPanel.classList.add('hidden');
      }

      if(currentRole === 'player'){
        const playerIdx = currentPlayerIdx || '1';
        activateTab(playerIdx);
        tabs.forEach(t => t.classList.toggle('hidden', t.dataset.idx !== playerIdx));
      } else {
        tabs.forEach(t => t.classList.remove('hidden'));
      }

      applyVisibilityToAll();
    }

    // --- Zakładki ---

    function activateTab(idx){
      tabs.forEach(t=> t.classList.toggle('active', t.dataset.idx === String(idx)));
      panels.forEach(p=> p.style.display = (p.dataset.idx === String(idx)) ? 'block' : 'none');
      // lokalny backup (na starcie) – potem i tak nadpisze Firebase
      loadStateFromLocal(idx);
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        activateTab(tab.dataset.idx);
      });
    });

    // --- Widoczność / uprawnienia ---

    function applyVisibilityCheckboxes(){
      // tylko MG widzi checkboxy, ale logika i tak działa dla wszystkich
      const visName = $('#vis_name');
      const visHp = $('#vis_hp');
      const visInv = $('#vis_inventory');
      const allowHp = $('#allow_player_edit_hp');
      const allowInv = $('#allow_player_edit_inv');
      if (!visName) return;

      visName.checked = visibility.showName;
      visHp.checked = visibility.showHP;
      visInv.checked = visibility.showInventory;
      allowHp.checked = visibility.allowPlayerEditHP;
      allowInv.checked = visibility.allowPlayerEditInv;
    }

    function applyVisibilityToPanel(panel){
      const v = visibility;

      // Imię
      const nameEl = panel.querySelector('.character-name');
      if(nameEl){
        nameEl.style.display = v.showName ? 'block' : 'none';
      }

      // Ekwipunek
      panel.querySelectorAll('.inv').forEach(i=>{
        const wrapper = i.closest('.inventory-item');
        if(wrapper) wrapper.style.display = v.showInventory ? 'block' : 'none';
      });

      // HP (same cyferki, label zostaje)
      panel.querySelectorAll('.body-part').forEach(bp=>{
        bp.querySelectorAll('input').forEach(inp=>{
          inp.style.display = v.showHP ? 'inline-block' : 'none';
        });
      });

      // readonly dla gracza
      if(currentRole === 'player'){
        const playerIdx = currentPlayerIdx || '1';
        if(panel.dataset.idx !== playerIdx) return;
        panel.querySelectorAll('.hp-cur, .hp-max').forEach(i=> i.readOnly = !v.allowPlayerEditHP);
        panel.querySelectorAll('.inv').forEach(i=> i.readOnly = !v.allowPlayerEditInv);
      } else {
        panel.querySelectorAll('.hp-cur, .hp-max').forEach(i=> i.readOnly = false);
        panel.querySelectorAll('.inv').forEach(i=> i.readOnly = false);
      }
    }

    function applyVisibilityToAll(){
      panels.forEach(panel => applyVisibilityToPanel(panel));
    }

    // --- Zdarzenia ---

    // input -> zapis / sync
    document.addEventListener('input', e=>{
      const panel = e.target.closest('.panel');
      if(!panel) return;
      const idx = panel.dataset.idx;
      updateColorsFor(panel);

      if(isApplyingFromServer) return; // nie echo’ujemy zmian z Firebase

      const role = currentRole;
      const v = visibility;
      const isHpInput = e.target.classList.contains('hp-cur') || e.target.classList.contains('hp-max');
      const isInvInput = e.target.classList.contains('inv');

      if(role === 'gm'){
        // MG zawsze pcha do Firebase
        saveStateFor(idx, {push:true});
      } else if(role === 'player'){
        let canPush = false;
        if(isHpInput && v.allowPlayerEditHP) canPush = true;
        if(isInvInput && v.allowPlayerEditInv) canPush = true;
        saveStateFor(idx, {push:canPush});
      } else {
        // Nie wybrano roli – tylko lokalny zapis
        saveStateFor(idx, {push:false});
      }
    });

    // Eksport / import JSON
    document.querySelectorAll('[data-action="export"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const panel = e.target.closest('.panel');
        const idx = panel.dataset.idx;
        const str = localStorage.getItem(storageKeyFor(idx)) || '{}';
        prompt('Skopiuj JSON (export):', str);
      });
    });

    document.querySelectorAll('[data-action="import"]').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const panel = e.target.closest('.panel');
        const idx = panel.dataset.idx;
        const txt = prompt('Wklej JSON do importu:');
        if(!txt) return;
        try{
          const state = JSON.parse(txt);
          // lokalnie
          localStorage.setItem(storageKeyFor(idx), txt);
          // do Firebase
          db.ref('games/'+gameId+'/characters/'+idx).set(state);
          // i od razu aplikujemy
          isApplyingFromServer = true;
          applyStateToPanel(panel, state);
          updateColorsFor(panel);
          isApplyingFromServer = false;
          alert('Zaimportowano');
        }catch(err){
          alert('Błąd JSON: '+err.message);
        }
      });
    });

    // Ustawienia MG -> checkboxy visibility
    ['vis_name','vis_hp','vis_inventory','allow_player_edit_hp','allow_player_edit_inv'].forEach(id=>{
      const el = $('#'+id);
      if(!el) return;
      el.addEventListener('change', ()=>{
        visibility.showName = $('#vis_name').checked;
        visibility.showHP = $('#vis_hp').checked;
        visibility.showInventory = $('#vis_inventory').checked;
        visibility.allowPlayerEditHP = $('#allow_player_edit_hp').checked;
        visibility.allowPlayerEditInv = $('#allow_player_edit_inv').checked;
        pushVisibilityToServer();
        applyVisibilityToAll();
      });
    });

    // Przycisk "Ustawienia MG" – szybki switch do MG
    $('#openRoleSettings').addEventListener('click', ()=>{
      roleSelect.value = 'gm';
      rememberRole.checked = false;
      saveRole('gm', false);
      applyRoleUI();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Zmiana roli
    roleSelect.addEventListener('change', e=>{
      const r = e.target.value;
      if(rememberRole.checked) saveRole(r, true);
      currentRole = r;
      if(r === 'player'){
        askWhichPlayer();
      } else {
        applyRoleUI();
      }
    });

    rememberRole.addEventListener('change', ()=>{
      if(rememberRole.checked){
        saveRole(roleSelect.value, true);
      } else {
        saveRole('unset', false);
      }
    });

    // --- Init ---

    (function init(){
      // role & player index
      const savedRole = loadSavedRole();
      if(savedRole && savedRole !== 'unset'){
        roleSelect.value = savedRole;
        rememberRole.checked = true;
        currentRole = savedRole;
      }
      currentPlayerIdx = localStorage.getItem('dndPlayerIndex') || currentPlayerIdx;

      // zakładki
      activateTab(currentPlayerIdx || '1');

      // Firebase subskrypcje
      subscribeToVisibility();
      subscribeToCharacter(1);
      subscribeToCharacter(2);

      // po ustaleniu roli
      if(currentRole === 'player'){
        askWhichPlayer();
      } else {
        applyRoleUI();
      }

      applyVisibilityToAll();
    })();

    // debug
    window._dnd = { collectStateFromPanel, applyStateToPanel, visibility };
  </script>
</body>
</html>


